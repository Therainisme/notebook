---
title: 关于试图整理进程、线程这件事
authors: [Therainisme]
tags: [OS,至未来的你]
date: 2022-5-18
---

明明快要考六级了为什么我这个人还这么闲？从为什么到是什么说起吧。

:::tip 反正
一切的一切都是为了性能和效率。
:::

<!--truncate-->

## 进程

### 为什么需要进程？

早期的操作系统是单道批处理的，CPU 非常高效，但 IO 是低速的。此时会出现 CPU 等待 IO 的情况，**CPU 利用率非常的低！**

如果一个程序在进行 IO 时，不如将这个程序挂起，切换到下一个需要 CPU 执行的程序。这样能保证昂贵的 CPU 资源能高效地利用。进程的概念便出现了。

### 进程这个实体需要什么？

通俗的讲，进程就是程序的一次执行过程。**程序是静态的**，作为操作系统中的一种资源。**进程是动态的**，它拥有像人一样的生命周期，会产生、变换和消亡。

每个进程都有属于自己的、私有的、地址连续的虚拟内存。最终进程的数据及代码必然要放到物理内存上，必须有某种机制：能记住虚拟地址空间中的某个数据被放到了哪个物理内存地址上。（地址空间映射，也是虚拟内存地址与物理内存地址的映射关系）。

可以用**页表**，它记录了虚拟内存地址与物理内存地址的映射关系，进程通过页表访问内存是可以将虚拟地址转换为物理地址。（这种机制被称为**虚拟内存**）

操作系统会给进程维护一个进程控制块（PCB）。它时操作系统掌握进程的唯一资料结构和管理进程的主要依据。PCB 是进程存在的唯一标志，创建进程和撤销进程等对进程的操作都是对 PCB 的操作。PCB 一般会包含以下四类信息：

1. 进程描述信息：让操作系统区分每个不同的进程，进程被创建时，会被操作系统分配一个唯一的 PID。（当然描述信息还包括用户 ID UID）
2. 进程控制和管理信息：记录进程的运行情况。CPU 使用时间、磁盘使用情况、网络使用情况等。
3. 资源分配清单：记录进程使用了什么资源、比如内存、IO设备、文件等。
4. CPU 相关信息：进程在退出时，必须保存该进程在 CPU 中的各种信息，用于实现进程切换。确保进程恢复时从上次退出的地方继续执行。（一般存寄存器信息等）

### 进程切换开销

尽管每个进程可以拥有属于自己的地址空间，但是所有进程必须共享CPU寄存器，因此，在恢复一个进程的执行前，内核必须确保每个寄存器装入了挂起进程时的值。这是其中一个最显著的性能损耗。

操作系统还需要切换页目录，以使用新的地址空间。但页表查找是一个很慢的过程，因此通常使用 TLB Cache 来缓存常用的地址映射，这样可以加速页表查找。当进程切换后页表也要进行切换，页表切换后 TLB 就失效了，导致 Cache 失效命中率降低。

## 线程

线程为了解决进程切换开销大的问题诞生了。

把进程作为资源分配单位和调度单位这两个属性分开处理，即**进程还是作为资源分配的基本单位**，但是不作为调度的基本单位（很少调度或切换），**把调度执行与切换的责任交给线程**，即线程成为独立调度的基本单位，它比进程更容易（更快）创建，也更容易撤销。

### 线程解决进程的问题

一个进程中可以同时存在多个线程，这些线程共享该进程的所有资源。所以，线程的切换也就少了切换页表等开销极大的工作。而且，线程之间能够非常方便、快速地共享数据，只需要将数据复制到进程的共享区域。

### 线程还存在的问题

同进程间的线程切换，其开销主要来源于用户态与内核态之间的转化。（协程比线程更小，协程的切换是由用户态的调度器来实现的，不会再用户态和内核态之间切换）

> 大概是这样吧，饿了，干饭！